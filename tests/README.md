# üß™ –¢–µ—Å—Ç—ã –¥–ª—è Production Analysis API

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–¢–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π API —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:
- **pytest** - —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **httpx AsyncClient** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π HTTP –∫–ª–∏–µ–Ω—Ç
- **PostgreSQL –≤ Docker** - —Ä–µ–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–æ–≤

## üöÄ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–ø—É—Å–∫—É

### 1. –ó–∞–ø—É—Å–∫ PostgreSQL –≤ Docker
```bash
cd docker
docker-compose up -d
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```bash
pip install -r requirements-test.txt
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ PostgreSQL –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `localhost:5432` —Å —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: `postgres`
- –ü–∞—Ä–æ–ª—å: `postgres`
- –ë–∞–∑–∞: `prod_analysis` (–æ—Å–Ω–æ–≤–Ω–∞—è)
- –¢–µ—Å—Ç–æ–≤–∞—è –±–∞–∑–∞: `prod_analysis_test` (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

## üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
```bash
pytest tests/ -v
```

### –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
```bash
pytest tests/test_analytics.py::TestProductionDynamics::test_production_dynamics_yearly_aggregation -v
```

### –ó–∞–ø—É—Å–∫ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
```bash
pytest tests/ -v -s
```

### –ó–∞–ø—É—Å–∫ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
```bash
pytest tests/ --cov=backend --cov-report=html
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

### `conftest.py`
- **`setup_test_db`** - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î –∏ —Ç–∞–±–ª–∏—Ü
- **`db_session`** - —Å–µ—Å—Å–∏—è –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞
- **`client`** - HTTP –∫–ª–∏–µ–Ω—Ç —Å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å—é –ë–î
- **`test_data`** - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –æ—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### `test_analytics.py`
- **`test_production_dynamics_yearly_aggregation`** - –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ –≥–æ–¥–∞–º
- **`test_production_dynamics_with_field_filter`** - —Ç–µ—Å—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—é
- **`test_production_dynamics_with_sediment_filter`** - —Ç–µ—Å—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∫–æ–º–ø–ª–µ–∫—Å—É
- **`test_production_dynamics_monthly_aggregation`** - —Ç–µ—Å—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ –º–µ—Å—è—Ü–∞–º
- **`test_production_dynamics_validation_errors`** - —Ç–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- **`test_production_dynamics_no_data`** - —Ç–µ—Å—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–∞–Ω–Ω—ã—Ö

## üéØ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

### –°–æ–∑–¥–∞–≤–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:
1. **2 –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—è**:
   - "–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ –ê" (–æ–ø–µ—Ä–∞—Ç–æ—Ä: –ì–∞–∑–ø—Ä–æ–º)
   - "–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ –ë" (–æ–ø–µ—Ä–∞—Ç–æ—Ä: –†–æ—Å–Ω–µ—Ñ—Ç—å)

2. **2 –æ–±—ä–µ–∫—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**:
   - –û–±—ä–µ–∫—Ç –ê1 (—Å–µ–Ω–æ–º–∞–Ω) –≤ –ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–∏ –ê
   - –û–±—ä–µ–∫—Ç –ë1 (—Ç—É—Ä–æ–Ω) –≤ –ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–∏ –ë

3. **2 —Ñ–ª—é–∏–¥–∞**:
   - –ì–∞–∑ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

4. **2 —Å–∫–≤–∞–∂–∏–Ω—ã**:
   - –ü–æ –æ–¥–Ω–æ–π –Ω–∞ –∫–∞–∂–¥–æ–µ –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ

5. **72 –∑–∞–ø–∏—Å–∏ –¥–æ–±—ã—á–∏**:
   - 3 –≥–æ–¥–∞ √ó 12 –º–µ—Å—è—Ü–µ–≤ √ó 2 —Å–∫–≤–∞–∂–∏–Ω—ã
   - –î–∞–Ω–Ω—ã–µ –∑–∞ 2021-2023 –≥–æ–¥—ã
   - –†–∞–∑–ª–∏—á–Ω—ã–µ –æ–±—ä–µ–º—ã –¥–æ–±—ã—á–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–π

### –ü–∞—Ç—Ç–µ—Ä–Ω –¥–∞–Ω–Ω—ã—Ö:
- **–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ –ê**: 1000 + (–º–µ—Å—è—Ü √ó 10) —Ç—ã—Å. –º¬≥
- **–ú–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–µ –ë**: 800 + (–º–µ—Å—è—Ü √ó 8) —Ç—ã—Å. –º¬≥

## ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### 1. **–ë–∞–∑–æ–≤–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è**
- –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –≥–æ–¥–∞–º –¥–ª—è –≤—Å–µ—Ö –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π

### 2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è**
- –ü–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –º–µ—Å—Ç–æ—Ä–æ–∂–¥–µ–Ω–∏—é
- –ü–æ –∫–æ–º–ø–ª–µ–∫—Å—É –æ—Ç–ª–æ–∂–µ–Ω–∏–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 3. **–†–∞–∑–ª–∏—á–Ω—ã–µ —à–∞–≥–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏**
- –ì–æ–¥–æ–≤–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è (3 –ø–µ—Ä–∏–æ–¥–∞)
- –ú–µ—Å—è—á–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è (12 –ø–µ—Ä–∏–æ–¥–æ–≤)

### 4. **–í–∞–ª–∏–¥–∞—Ü–∏—è**
- –ù–µ–≤–µ—Ä–Ω—ã–µ —Ç–∏–ø—ã —Ñ–ª—é–∏–¥–æ–≤
- –ù–µ–≤–µ—Ä–Ω—ã–µ —à–∞–≥–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
- –ù–µ–≤–µ—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç

### 5. **–ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏**
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

## üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞ –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è:
```sql
TRUNCATE TABLE production RESTART IDENTITY CASCADE;
TRUNCATE TABLE wells RESTART IDENTITY CASCADE;
TRUNCATE TABLE fluids RESTART IDENTITY CASCADE;
TRUNCATE TABLE development_objects RESTART IDENTITY CASCADE;
TRUNCATE TABLE fields RESTART IDENTITY CASCADE;
```

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ PostgreSQL
```bash
docker logs prod_analysis_postgres
```

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
```bash
docker exec -it prod_analysis_postgres psql -U postgres -d prod_analysis_test
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
```sql
\dt
SELECT * FROM fields;
SELECT * FROM production LIMIT 10;
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **PostgreSQL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω** –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Ç–µ—Å—Ç–æ–≤
2. **–¢–µ—Å—Ç–æ–≤–∞—è –ë–î —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
3. **–î–∞–Ω–Ω—ã–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã** - –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —á–∏—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
4. **Enum'—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ä—É—Å—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è** —Å–æ–≥–ª–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Å—Ö–µ–º–µ
5. **–¢–µ—Å—Ç—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è pytest-asyncio

## üéâ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –≤—Å–µ —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–π—Ç–∏:
```
tests/test_analytics.py::TestProductionDynamics::test_production_dynamics_yearly_aggregation PASSED
tests/test_analytics.py::TestProductionDynamics::test_production_dynamics_with_field_filter PASSED
tests/test_analytics.py::TestProductionDynamics::test_production_dynamics_with_sediment_filter PASSED
tests/test_analytics.py::TestProductionDynamics::test_production_dynamics_monthly_aggregation PASSED
tests/test_analytics.py::TestProductionDynamics::test_production_dynamics_validation_errors PASSED
tests/test_analytics.py::TestProductionDynamics::test_production_dynamics_no_data PASSED

====== 6 passed in X.XXs ======
```
